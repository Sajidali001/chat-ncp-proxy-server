<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat NCP Client Portal</title>
    <link rel="icon" type="image/png" href="NCP Logo Transparent.png" sizes="48x48">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #115440;
            --primary-dark: #0d4233;
            --secondary: #0f4251;
            --accent: #48ac60;
            --light-accent: #84bc98;
            --shine: #a8e6cf;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #48ac60;
            --danger: #e63946;
            --warning: #f4a261;
            --info: #2a9d8f;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
            --border-radius: 12px;
            --box-shadow: 0 10px 20px rgba(17, 84, 64, 0.15);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f0f7f4 0%, #e0f0e9 100%);
            min-height: 100vh;
            color: var(--gray-800);
            line-height: 1.6;
            position: relative;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 10% 20%, rgba(168, 230, 207, 0.15) 0%, transparent 20%),
                        radial-gradient(circle at 90% 80%, rgba(72, 172, 96, 0.1) 0%, transparent 20%);
            z-index: -1;
        }

        .app-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background: linear-gradient(120deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .sidebar::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(168, 230, 207, 0.3) 0%, transparent 70%);
            transform: rotate(30deg);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-container img {
            width: 92.375px;
            height: 22.375px;
        }

        .logo-text {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 1.4rem;
        }

        .logo-text .logo {
            color: var(--shine);
        }

        .new-chat-btn {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            padding: 10px 15px;
            margin: 15px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            transition: var(--transition);
            width: calc(100% - 20px);
            margin-left: 10px;
            position: relative;
        }

        .new-chat-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .new-chat-btn i {
            pointer-events: none; /* Make sure icon doesn't interfere with button click */
        }

        .new-chat-btn span {
            pointer-events: none; /* Make sure text doesn't interfere with button click */
        }

        .history-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            position: relative;
        }

        .history-title {
            padding: 10px 15px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        .history-list {
            list-style: none;
        }

        .history-item {
            padding: 12px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            font-size: 0.95rem;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .history-item.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .history-item-content {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-grow: 1;
        }

        .history-item-actions {
            display: flex;
            gap: 8px;
        }

        .history-item-actions i {
            font-size: 0.9rem;
            padding: 5px;
            border-radius: 4px;
        }

        .history-item-actions .edit-chat {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .history-item-actions .edit-chat:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .history-item-actions .delete-chat {
            background: rgba(230, 57, 70, 0.2);
            color: #ff6b6b;
        }

        .history-item-actions .delete-chat:hover {
            background: rgba(230, 57, 70, 0.3);
        }

        .history-item i {
            font-size: 0.9rem;
        }

        .sidebar-footer {
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .api-key-display {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: var(--border-radius);
            font-size: 0.8rem;
            font-family: 'Roboto Mono', monospace;
            word-break: break-all;
            max-height: 60px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .logout-btn {
            background: rgba(230, 57, 70, 0.2);
            color: #ff6b6b;
            border: 1px solid rgba(230, 57, 70, 0.3);
            border-radius: var(--border-radius);
            padding: 8px 15px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            transition: var(--transition);
            width: 100%;
        }

        .logout-btn:hover {
            background: rgba(230, 57, 70, 0.3);
            transform: translateY(-2px);
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .main-header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 5;
        }

        .model-selector-container {
            position: relative;
            flex: 1;
            max-width: 300px;
        }

        .shortcut-buttons {
            display: flex;
            gap: 10px;
            margin-left: 10px;
        }

        .shortcut-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .shortcut-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .shortcut-btn.active {
            background: var(--accent);
            box-shadow: 0 0 0 2px white, 0 0 0 4px var(--accent);
        }

        .model-selector {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-family: 'Roboto', sans-serif;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .model-selector:hover {
            border-color: var(--accent);
        }

        .model-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--gray-300);
            border-top: none;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .model-dropdown.active {
            display: block;
        }

        .model-search {
            padding: 12px 15px;
            border: none;
            border-bottom: 1px solid var(--gray-200);
            width: 100%;
            font-family: 'Roboto', sans-serif;
            font-size: 1rem;
        }

        .model-list {
            list-style: none;
            max-height: 250px;
            overflow-y: auto;
        }

        .model-item {
            padding: 12px 15px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid var(--gray-100);
        }

        .model-item:hover {
            background: var(--gray-100);
        }

        .model-item.selected {
            background: rgba(72, 172, 96, 0.1);
            color: var(--accent);
            font-weight: 500;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .message {
            padding: 20px 0;
            border-bottom: 1px solid var(--gray-200);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message:last-child {
            border-bottom: none;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .user-avatar {
            background: linear-gradient(120deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .assistant-avatar {
            background: linear-gradient(120deg, var(--accent) 0%, #3a9b52 100%);
            color: white;
        }

        .message-role {
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
        }

        .message-content {
            padding-left: 42px;
            line-height: 1.6;
        }

        .message-content pre {
            background: var(--gray-100);
            padding: 15px;
            border-radius: var(--border-radius);
            overflow-x: auto;
            font-size: 0.9rem;
            margin: 10px 0;
        }

        .message-content img {
            max-width: 100%;
            border-radius: var(--border-radius);
            margin: 10px 0;
        }

        .image-container {
            position: relative;
            display: inline-block;
            margin: 10px 0;
        }

        .image-container a {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.8rem;
            transition: var(--transition);
        }

        .image-container a:hover {
            background: rgba(0,0,0,0.9);
            transform: translateY(-2px);
        }

        .image-container a i {
            margin-right: 5px;
        }

        .input-container {
            padding: 15px;
            background: white;
            border-top: 1px solid var(--gray-200);
            position: relative;
            margin-bottom: 10px;
        }

        .input-box {
            border: 2px solid var(--gray-300);
            border-radius: var(--border-radius);
            padding: 15px;
            background: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .input-box:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(72, 172, 96, 0.2);
        }

        .message-input {
            width: 100%;
            border: none;
            resize: none;
            font-family: 'Roboto', sans-serif;
            font-size: 1rem;
            outline: none;
            max-height: 200px;
            padding: 10px 0;
            min-height: 60px;
            flex-grow: 1;
            box-sizing: border-box;
        }

        .input-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            width: 100%;
            gap: 10px;
        }

        .upload-container {
            position: relative;
            flex-shrink: 0;
        }

        .upload-btn {
            background: var(--gray-100);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .upload-btn:hover {
            background: var(--gray-200);
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .send-btn {
            background: linear-gradient(120deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 10px rgba(17, 84, 64, 0.3);
            flex-shrink: 0;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(17, 84, 64, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .image-preview {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .preview-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.7rem;
        }

        /* Login Section */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 40px;
            max-width: 500px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .login-card::before {
            content: "";
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--accent), var(--shine), var(--accent));
            z-index: -1;
            border-radius: calc(var(--border-radius) + 2px);
            animation: shine 3s ease-in-out infinite alternate;
            opacity: 0.3;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            font-family: 'Poppins', sans-serif;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .login-header p {
            color: var(--gray-600);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--gray-700);
        }

        .form-group input {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-family: 'Roboto', sans-serif;
            font-size: 1rem;
            transition: var(--transition);
            background: var(--gray-100);
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent);
            background: white;
            box-shadow: 0 0 0 3px rgba(72, 172, 96, 0.2);
        }

        .login-btn {
            background: linear-gradient(120deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            transition: var(--transition);
            box-shadow: 0 4px 10px rgba(17, 84, 64, 0.3);
            width: 100%;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(17, 84, 64, 0.4);
        }

        .response {
            margin-top: 20px;
            padding: 20px;
            border-radius: var(--border-radius);
            background-color: var(--gray-100);
            border-left: 4px solid var(--gray-300);
            white-space: pre-wrap;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
        }

        .response::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), var(--shine));
        }

        .success {
            background-color: rgba(72, 172, 96, 0.1);
            border-left-color: var(--success);
            color: var(--success);
        }

        .error {
            background-color: rgba(230, 57, 70, 0.1);
            border-left-color: var(--danger);
            color: var(--danger);
        }

        .hidden {
            display: none;
        }

        footer {
            text-align: center;
            padding: 15px;
            color: var(--gray-600);
            font-size: 0.9rem;
            border-top: 1px solid var(--gray-200);
            position: relative;
        }

        footer::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
        }

        .brand {
            color: var(--accent);
            font-weight: 600;
            position: relative;
        }

        .brand::after {
            content: "";
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--shine), transparent);
        }

        @keyframes shine {
            0% {
                opacity: 0.2;
            }
            100% {
                opacity: 0.4;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            
            .logo-text, .new-chat-btn span, .history-title, .history-item span, .sidebar-footer {
                display: none;
            }
            
            .new-chat-btn, .history-item {
                justify-content: center;
                padding: 15px;
            }
            
            .history-item i {
                font-size: 1.2rem;
            }
            
            .main-header {
                padding: 10px 15px;
            }
            
            .model-selector-container {
                max-width: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div id="loginSection" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1>Welcome to <span class="logo">Chat</span> NCP</h1>
                <p>Access powerful AI capabilities through our secure proxy service</p>
            </div>
            <form id="loginForm" novalidate>
                <div class="form-group">
                    <label for="clientApiKey">Your API Key:</label>
                    <input type="password" id="clientApiKey" placeholder="Enter your API key" required>
                </div>
                <button type="submit" class="login-btn">Login to Dashboard</button>
            </form>
            <div id="loginResponse" class="response hidden"></div>
        </div>
    </div>

    <!-- Main App (Hidden by default) -->
    <div id="appContainer" class="app-container hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <img src="NCP Logo Transparent.png" alt="NCP Logo">
                    <div class="logo-text"><span class="logo">Chat</span> NCP</div>
                </div>
            </div>
            <button id="newChatBtn" class="new-chat-btn">
                <i class="fas fa-plus"></i>
                <span>New Chat</span>
            </button>
            <div class="history-container">
                <div class="history-title">RECENT CHATS</div>
                <ul id="historyList" class="history-list">
                    <!-- Chat history items will be added here dynamically -->
                </ul>
            </div>
            <div class="sidebar-footer">
                <div class="api-key-display" id="sidebarApiKey"></div>
                <button id="logoutBtn" class="logout-btn">Logout</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="main-header">
                <div class="model-selector-container">
                    <div id="modelSelector" class="model-selector">
                        <span id="selectedModel">Select a model</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div id="modelDropdown" class="model-dropdown">
                        <input type="text" id="modelSearch" class="model-search" placeholder="Search models...">
                        <ul id="modelList" class="model-list">
                            <!-- Model options will be added here dynamically -->
                        </ul>
                    </div>
                </div>
                <!-- Shortcut buttons for model types -->
                <div class="shortcut-buttons">
                    <button id="chatShortcut" class="shortcut-btn">
                        <i class="fas fa-comment"></i> Chat
                    </button>
                    <button id="visionShortcut" class="shortcut-btn">
                        <i class="fas fa-eye"></i> Vision
                    </button>
                    <button id="imageShortcut" class="shortcut-btn">
                        <i class="fas fa-image"></i> Image
                    </button>
                </div>
            </div>

            <div id="chatContainer" class="chat-container">
                <!-- Messages will be added here dynamically -->
                <div class="message">
                    <div class="message-header">
                        <div class="avatar assistant-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-role">gpt-4o</div>
                    </div>
                    <div class="message-content">
                        <p>Hello! I'm the gpt-4o model. How can I help you today?</p>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <div class="input-box">
                    <textarea id="messageInput" class="message-input" placeholder="Message ChatNCP..." rows="1"></textarea>
                    <div class="input-actions">
                        <div class="upload-container">
                            <button id="uploadBtn" class="upload-btn">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <input type="file" id="fileInput" class="file-input" accept="image/*" multiple>
                        </div>
                        <button id="sendBtn" class="send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div id="imagePreview" class="image-preview hidden">
                        <!-- Image previews will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>© 2025 <span class="brand">Chat NCP</span> | Secure AI Access</p>
    </footer>

    <script>
        // Base URL for the proxy server
        const BASE_URL = 'http://192.168.1.249:7000';
        
        // Global variables
        let currentApiKey = null;
        let selectedModel = 'provider-3/gpt-4o';
        let chatHistory = [];
        let currentChatId = null;
        let uploadedImages = [];
        let currentMode = 'chat'; // 'chat', 'vision', or 'image'
        
        // DOM Elements
        const loginSection = document.getElementById('loginSection');
        const appContainer = document.getElementById('appContainer');
        const loginForm = document.getElementById('loginForm');
        const loginResponse = document.getElementById('loginResponse');
        const sidebarApiKey = document.getElementById('sidebarApiKey');
        const newChatBtn = document.getElementById('newChatBtn');
        const historyList = document.getElementById('historyList');
        const modelSelector = document.getElementById('modelSelector');
        const modelDropdown = document.getElementById('modelDropdown');
        const modelSearch = document.getElementById('modelSearch');
        const modelList = document.getElementById('modelList');
        const selectedModelSpan = document.getElementById('selectedModel');
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const logoutBtn = document.getElementById('logoutBtn');
        const chatShortcut = document.getElementById('chatShortcut');
        const visionShortcut = document.getElementById('visionShortcut');
        const imageShortcut = document.getElementById('imageShortcut');
        
        // Available models (in a real implementation, this would be fetched from the server)
        const availableModels = [
            'provider-3/gpt-4o',
            'provider-3/gpt-4o-mini',
            'provider-3/gpt-4-turbo',
            'provider-3/gpt-3.5-turbo',
            'provider-1/claude-3-5-sonnet',
            'provider-1/claude-3-opus',
            'provider-1/claude-3-sonnet',
            'provider-1/claude-3-haiku',
            'provider-2/gemini-pro',
            'provider-2/gemini-pro-vision',
            'provider-2/gemini-1.5-pro',
            'provider-2/gemini-1.5-flash'
        ];
        
        // Store fetched models to prevent re-fetching
        let fetchedModels = [];
        
        // Initialize the app
        function initApp() {
            console.log('Initializing app...');
            // Load chat history from localStorage
            loadChatHistory();
            
            // Create a new chat
            createNewChat();
            
            // Fetch models from upstream API
            fetchModels();
            
            // Set up event listeners
            setupEventListeners();
        }
        
        // Fetch models from upstream API
        async function fetchModels() {
            try {
                const response = await fetch(`${BASE_URL}/v1/models`, {
                    headers: {
                        'Authorization': `Bearer ${currentApiKey}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // Extract model names from the response
                    const models = data.data.map(model => model.id);
                    // Sort models alphabetically
                    models.sort();
                    // Store fetched models
                    fetchedModels = models;
                    // Populate model list with fetched models based on current mode
                    filterModelsByMode();
                } else {
                    console.error('Failed to fetch models, using default list');
                    // Fallback to hardcoded list if API call fails
                    fetchedModels = availableModels;
                    filterModelsByMode();
                }
            } catch (error) {
                console.error('Error fetching models:', error);
                // Fallback to hardcoded list if API call fails
                fetchedModels = availableModels;
                filterModelsByMode();
            }
        }
        
        // Set up event listeners
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            // Login form submission
            if (loginForm) {
                console.log('Adding login form event listener');
                loginForm.addEventListener('submit', handleLogin);
            } else {
                console.log('Login form not found');
            }
            
            // New chat button
            if (newChatBtn) {
                newChatBtn.addEventListener('click', createNewChat);
            }
            
            // Model selector
            if (modelSelector) {
                modelSelector.addEventListener('click', toggleModelDropdown);
            }
            
            // Model search
            if (modelSearch) {
                modelSearch.addEventListener('input', filterModels);
            }
            
            // Click outside to close dropdown
            document.addEventListener('click', (e) => {
                if (modelSelector && modelDropdown && !modelSelector.contains(e.target) && !modelDropdown.contains(e.target)) {
                    modelDropdown.classList.remove('active');
                }
            });
            
            // Message input
            if (messageInput) {
                messageInput.addEventListener('input', adjustTextareaHeight);
                messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
            
            // Send button
            if (sendBtn) {
                sendBtn.addEventListener('click', sendMessage);
            }
            
            // Upload button
            if (uploadBtn && fileInput) {
                uploadBtn.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', handleFileUpload);
            }
            
            // Logout button
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
            
            // Shortcut buttons
            if (chatShortcut) {
                chatShortcut.addEventListener('click', () => setMode('chat'));
            }
            
            if (visionShortcut) {
                visionShortcut.addEventListener('click', () => setMode('vision'));
            }
            
            if (imageShortcut) {
                imageShortcut.addEventListener('click', () => setMode('image'));
            }
            
            // Set initial mode
            setMode('chat');
        }
        
        // Set the current mode and filter models accordingly
        function setMode(mode) {
            currentMode = mode;
            
            // Update button states
            if (chatShortcut) chatShortcut.classList.remove('active');
            if (visionShortcut) visionShortcut.classList.remove('active');
            if (imageShortcut) imageShortcut.classList.remove('active');
            
            if (mode === 'chat') {
                if (chatShortcut) chatShortcut.classList.add('active');
            } else if (mode === 'vision') {
                if (visionShortcut) visionShortcut.classList.add('active');
            } else if (mode === 'image') {
                if (imageShortcut) imageShortcut.classList.add('active');
            }
            
            // Filter models based on mode
            filterModelsByMode();
        }
        
        // Filter models based on current mode
        function filterModelsByMode() {
            // Use fetched models if available, otherwise use hardcoded list
            const modelsToFilter = fetchedModels.length > 0 ? fetchedModels : availableModels;
            
            let filteredModels = [];
            if (currentMode === 'chat') {
                // Chat models - exclude vision and image generation models
                filteredModels = modelsToFilter.filter(model => 
                    !model.toLowerCase().includes('vision') && 
                    !model.toLowerCase().includes('gemini') && 
                    !model.toLowerCase().includes('gpt-4o') && 
                    !model.toLowerCase().includes('claude-3') &&
                    !model.toLowerCase().includes('flux') && 
                    !model.toLowerCase().includes('image') && 
                    !model.toLowerCase().includes('diffusion') && 
                    !model.toLowerCase().includes('stable')
                );
            } else if (currentMode === 'vision') {
                // Vision models
                filteredModels = modelsToFilter.filter(model => 
                    model.toLowerCase().includes('vision') || 
                    model.toLowerCase().includes('gemini') || 
                    model.toLowerCase().includes('gpt-4o') || 
                    model.toLowerCase().includes('claude-3')
                );
            } else if (currentMode === 'image') {
                // Image generation models
                filteredModels = modelsToFilter.filter(model => 
                    model.toLowerCase().includes('flux') || 
                    model.toLowerCase().includes('image') || 
                    model.toLowerCase().includes('diffusion') || 
                    model.toLowerCase().includes('stable')
                );
            }
            
            // If no models found for the mode, show all models
            if (filteredModels.length === 0) {
                filteredModels = modelsToFilter;
            }
            
            populateModelList(filteredModels);
        }
        
        // Populate model list
        function populateModelList(models) {
            modelList.innerHTML = '';
            models.forEach(model => {
                const li = document.createElement('li');
                li.className = 'model-item';
                li.textContent = model;
                if (model === selectedModel) {
                    li.classList.add('selected');
                }
                li.addEventListener('click', () => selectModel(model));
                modelList.appendChild(li);
            });
        }
        
        // Filter models based on search and mode
        function filterModels() {
            const searchTerm = modelSearch.value.toLowerCase();
            // Use fetched models if available, otherwise use hardcoded list
            const modelsToFilter = fetchedModels.length > 0 ? fetchedModels : availableModels;
            
            // First filter by mode
            let filteredModels = [];
            if (currentMode === 'chat') {
                // Chat models - exclude vision and image generation models
                filteredModels = modelsToFilter.filter(model => 
                    !model.toLowerCase().includes('vision') && 
                    !model.toLowerCase().includes('gemini') && 
                    !model.toLowerCase().includes('gpt-4o') && 
                    !model.toLowerCase().includes('claude-3') &&
                    !model.toLowerCase().includes('flux') && 
                    !model.toLowerCase().includes('image') && 
                    !model.toLowerCase().includes('diffusion') && 
                    !model.toLowerCase().includes('stable')
                );
            } else if (currentMode === 'vision') {
                // Vision models
                filteredModels = modelsToFilter.filter(model => 
                    model.toLowerCase().includes('vision') || 
                    model.toLowerCase().includes('gemini') || 
                    model.toLowerCase().includes('gpt-4o') || 
                    model.toLowerCase().includes('claude-3')
                );
            } else if (currentMode === 'image') {
                // Image generation models
                filteredModels = modelsToFilter.filter(model => 
                    model.toLowerCase().includes('flux') || 
                    model.toLowerCase().includes('image') || 
                    model.toLowerCase().includes('diffusion') || 
                    model.toLowerCase().includes('stable')
                );
            }
            
            // If no models found for the mode, show all models
            if (filteredModels.length === 0) {
                filteredModels = modelsToFilter;
            }
            
            // Then filter by search term
            filteredModels = filteredModels.filter(model => 
                model.toLowerCase().includes(searchTerm)
            );
            
            populateModelList(filteredModels);
        }
        
        // Select a model
        function selectModel(model) {
            selectedModel = model;
            // Display clean model name
            selectedModelSpan.textContent = cleanModelName(model);
            modelDropdown.classList.remove('active');
            
            // Update selected class in model list
            document.querySelectorAll('.model-item').forEach(item => {
                item.classList.remove('selected');
                if (item.textContent === model) {
                    item.classList.add('selected');
                }
            });
            
            // Debug: Log the selected model
            console.log('Selected model:', model);
            
            // Debug: Check if it's a vision model
            if (model.toLowerCase().includes('vision') || model.toLowerCase().includes('gemini') || model.toLowerCase().includes('gpt-4o') || model.toLowerCase().includes('claude-3')) {
                console.log('Selected model is a vision model');
            }
            
            // Debug: Check if it's an image generation model
            if (model.toLowerCase().includes('flux') || model.toLowerCase().includes('image') || model.toLowerCase().includes('diffusion') || model.toLowerCase().includes('stable')) {
                console.log('Selected model is an image generation model');
            }
        }
        
        // Create a new chat
        function createNewChat() {
            currentChatId = Date.now().toString();
            const newChat = {
                id: currentChatId,
                title: 'New Chat',
                messages: [],
                createdAt: new Date().toISOString()
            };
            
            chatHistory.unshift(newChat);
            saveChatHistory();
            renderChatHistory();
            clearChat();
            
            // Add welcome message with the currently selected model (clean name)
            addMessageToChat('assistant', `Hello! I'm the ${cleanModelName(selectedModel)} model. How can I help you today?`, [], selectedModel);
        }
        
        // Clear chat container
        function clearChat() {
            chatContainer.innerHTML = '';
        }
        
        // Add message to chat
        function addMessageToChat(role, content, images = [], modelName = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            const avatarClass = role === 'user' ? 'user-avatar' : 'assistant-avatar';
            const avatarIcon = role === 'user' ? 'fa-user' : 'fa-robot';
            // Use the clean model name if provided, otherwise default to role-based names
            const roleName = role === 'user' ? 'You' : (modelName ? cleanModelName(modelName) : 'Assistant');
            
            // Format content as HTML
            const formattedContent = formatMessageContent(content);
            
            // Generate HTML for images with download functionality
            let imagesHtml = '';
            if (images.length > 0) {
                imagesHtml = images.map((img, index) => {
                    // For proxy URLs (generated images), we need to use our download function
                    if (img.startsWith('http') && img.includes('/v1/images/serve/')) {
                        return `
                            <div class="image-container" style="position: relative; display: inline-block; margin: 10px 0;">
                                <img src="${img}" alt="Generated image" style="max-width: 100%; border-radius: var(--border-radius); margin-bottom: 10px;">
                                <button onclick="downloadImage('${img}', 'generated-image-${Date.now()}-${index}.png')" 
                                   style="position: absolute; bottom: 15px; right: 15px; 
                                          background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; 
                                          border-radius: 4px; text-decoration: none; font-size: 0.8rem; border: none; cursor: pointer;">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            </div>
                        `;
                    } else {
                        // For data URLs (uploaded images), we can download directly
                        return `
                            <div class="image-container" style="position: relative; display: inline-block; margin: 10px 0;">
                                <img src="${img}" alt="Uploaded image" style="max-width: 100%; border-radius: var(--border-radius); margin-bottom: 10px;">
                                <button onclick="downloadImage('${img}', 'uploaded-image-${Date.now()}-${index}.png')" 
                                   style="position: absolute; bottom: 15px; right: 15px; 
                                          background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; 
                                          border-radius: 4px; text-decoration: none; font-size: 0.8rem; border: none; cursor: pointer;">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            </div>
                        `;
                    }
                }).join('');
            }
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="avatar ${avatarClass}">
                        <i class="fas ${avatarIcon}"></i>
                    </div>
                    <div class="message-role">${roleName}</div>
                </div>
                <div class="message-content">
                    ${formattedContent}
                    ${imagesHtml}
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Save message to chat history
            const chat = chatHistory.find(c => c.id === currentChatId);
            if (chat) {
                chat.messages.push({
                    role: role,
                    content: content,
                    images: images,
                    modelName: modelName
                });
                saveChatHistory();
            }
        }
        
        // Function to download images through the proxy
        async function downloadImage(imageUrl, filename) {
            try {
                // For data URLs (uploaded images), we can download directly
                if (imageUrl.startsWith('data:')) {
                    const link = document.createElement('a');
                    link.href = imageUrl;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    return;
                }
                
                // For proxy URLs, fetch the image through the proxy with authentication
                const response = await fetch(imageUrl, {
                    headers: {
                        'Authorization': `Bearer ${currentApiKey}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch image: ${response.status}`);
                }
                
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error downloading image:', error);
                alert('Error downloading image: ' + error.message);
            }
        }
        
        // Format message content with proper HTML
        function formatMessageContent(content) {
            if (!content) return '<p></p>';
            
            // Convert markdown-style lists to HTML
            let formatted = content
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            // Wrap in paragraph tags if not already
            if (!formatted.startsWith('<p>')) {
                formatted = '<p>' + formatted + '</p>';
            }
            
            // Convert bullet points
            formatted = formatted.replace(/<p>\s*•\s*(.*?)<\/p>/g, '<ul><li>$1</li></ul>');
            formatted = formatted.replace(/<p>\s*\*\s*(.*?)<\/p>/g, '<ul><li>$1</li></ul>');
            formatted = formatted.replace(/<p>\s*-\s*(.*?)<\/p>/g, '<ul><li>$1</li></ul>');
            
            // Convert numbered lists
            formatted = formatted.replace(/<p>\s*\d+\.\s*(.*?)<\/p>/g, '<ol><li>$1</li></ol>');
            
            // Convert bold and italic markdown
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Convert code blocks
            formatted = formatted.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            formatted = formatted.replace(/`(.*?)`/g, '<code>$1</code>');
            
            return formatted;
        }
        
        // Adjust textarea height
        function adjustTextareaHeight() {
            messageInput.style.height = 'auto';
            messageInput.style.height = (messageInput.scrollHeight > 200 ? 200 : messageInput.scrollHeight) + 'px';
        }
        
        // Handle file upload
        function handleFileUpload(e) {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        uploadedImages.push({
                            name: file.name,
                            data: event.target.result
                        });
                        renderImagePreview();
                    };
                    reader.readAsDataURL(file);
                }
            });
            fileInput.value = '';
        }
        
        // Render image preview
        function renderImagePreview() {
            if (uploadedImages.length === 0) {
                imagePreview.classList.add('hidden');
                return;
            }
            
            imagePreview.classList.remove('hidden');
            imagePreview.innerHTML = '';
            
            uploadedImages.forEach((image, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                previewItem.innerHTML = `
                    <img src="${image.data}" alt="${image.name}">
                    <div class="remove-image" data-index="${index}">
                        <i class="fas fa-times"></i>
                    </div>
                `;
                imagePreview.appendChild(previewItem);
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.remove-image').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.getAttribute('data-index'));
                    uploadedImages.splice(index, 1);
                    renderImagePreview();
                });
            });
        }
        
        // Send message
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message && uploadedImages.length === 0) return;
            
            // Add user message to chat
            addMessageToChat('user', message, uploadedImages.map(img => img.data));
            
            // Clear input and reset
            messageInput.value = '';
            uploadedImages = [];
            renderImagePreview();
            adjustTextareaHeight();
            
            // Disable send button while processing
            sendBtn.disabled = true;
            
            try {
                // Try to send message with selected model
                const response = await sendChatMessage(selectedModel, message);
                
                if (response.ok) {
                    // Handle different response types based on the endpoint used
                    if (response.endpoint === 'images/generations' && response.data.data) {
                        // Handle image generation response
                        response.data.data.forEach(imageObj => {
                            if (imageObj.url) {
                                addMessageToChat('assistant', `Here is the generated image:`, [imageObj.url], selectedModel);
                            }
                        });
                    } else if (response.data.choices && response.data.choices.length > 0) {
                        // Handle chat completion response
                        const assistantMessage = response.data.choices[0].message.content;
                        addMessageToChat('assistant', assistantMessage, [], selectedModel);
                    } else {
                        // Handle other response types
                        addMessageToChat('assistant', JSON.stringify(response.data, null, 2), [], selectedModel);
                    }
                } else {
                    // If the selected model fails, try to find an alternative model
                    const errorMessage = response.error || 'Something went wrong';
                    addMessageToChat('assistant', `Error with model ${selectedModel}: ${errorMessage}. Trying alternative model...`, [], selectedModel);
                    
                    // Try to find an alternative model
                    const alternativeModel = await findAlternativeModel(selectedModel);
                    if (alternativeModel) {
                        addMessageToChat('assistant', `Switching to model: ${cleanModelName(alternativeModel)}`, [], alternativeModel);
                        const altResponse = await sendChatMessage(alternativeModel, message);
                        if (altResponse.ok) {
                            // Handle different response types for the alternative model
                            if (altResponse.endpoint === 'images/generations' && altResponse.data.data) {
                                // Handle image generation response
                                altResponse.data.data.forEach(imageObj => {
                                    if (imageObj.url) {
                                        addMessageToChat('assistant', `Here is the generated image:`, [imageObj.url], alternativeModel);
                                    }
                                });
                            } else if (altResponse.data.choices && altResponse.data.choices.length > 0) {
                                // Handle chat completion response
                                const assistantMessage = altResponse.data.choices[0].message.content;
                                addMessageToChat('assistant', assistantMessage, [], alternativeModel);
                            } else {
                                // Handle other response types
                                addMessageToChat('assistant', JSON.stringify(altResponse.data, null, 2), [], alternativeModel);
                            }
                        } else {
                            const altErrorMessage = altResponse.error || 'Something went wrong';
                            addMessageToChat('assistant', `Error with alternative model ${cleanModelName(alternativeModel)}: ${altErrorMessage}`, [], alternativeModel);
                        }
                    } else {
                        addMessageToChat('assistant', 'No alternative models available.', [], selectedModel);
                    }
                }
            } catch (error) {
                addMessageToChat('assistant', `Error: ${error.message}`, [], selectedModel);
            } finally {
                sendBtn.disabled = false;
            }
        }
        
        // Send chat message to API
        async function sendChatMessage(model, message) {
            try {
                // Determine the appropriate endpoint based on the model name
                let endpoint = 'chat/completions';
                let requestData = {};
                
                console.log('Determining endpoint for model:', model);
                
                // Check if this is an image generation model
                if (model.toLowerCase().includes('flux') || model.toLowerCase().includes('image') || model.toLowerCase().includes('diffusion') || model.toLowerCase().includes('stable')) {
                    console.log('Detected image generation model');
                    endpoint = 'images/generations';
                    // For image generation, we need to send the prompt as the main content
                    requestData = {
                        model: model,
                        prompt: message,
                        n: 1,
                        size: "1024x1024" // Default size
                    };
                    
                    console.log('Sending image generation request:', requestData);
                } 
                // Check if this is a vision model that can handle images
                else if (model.toLowerCase().includes('vision') || model.toLowerCase().includes('gemini') || model.toLowerCase().includes('gpt-4o') || model.toLowerCase().includes('claude-3')) {
                    console.log('Detected vision model');
                    // For vision models, we keep the chat completions endpoint but with image content
                    endpoint = 'chat/completions';
                    
                    // Format the message content properly for vision models
                    if (uploadedImages.length > 0) {
                        // Create an array of content objects
                        const content = [];
                        
                        // Add text message if present
                        if (message) {
                            content.push({ type: "text", text: message });
                        }
                        
                        // Add each uploaded image
                        uploadedImages.forEach(img => {
                            content.push({
                                type: "image_url",
                                image_url: {
                                    url: img.data
                                }
                            });
                        });
                        
                        requestData = {
                            model: model,
                            messages: [
                                {
                                    role: "user",
                                    content: content
                                }
                            ]
                        };
                    } else {
                        // No images, just text
                        requestData = {
                            model: model,
                            messages: [
                                {
                                    role: "user",
                                    content: message
                                }
                            ]
                        };
                    }
                    
                    console.log('Sending vision model request:', requestData);
                }
                // For regular chat models
                else {
                    endpoint = 'chat/completions';
                    
                    // For regular models, we don't send images as they can't process them
                    requestData = {
                        model: model,
                        messages: [
                            {
                                role: "user",
                                content: message
                            }
                        ]
                    };
                    
                    console.log('Sending chat model request:', requestData);
                }
                
                // Make API request
                console.log(`Making request to ${BASE_URL}/v1/${endpoint}`, requestData);
                const response = await fetch(`${BASE_URL}/v1/${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentApiKey}`
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('API response status:', response.status);
                const data = await response.json();
                console.log('API response data:', data);
                
                return {
                    ok: response.ok,
                    data: data,
                    error: data.error,
                    endpoint: endpoint // Return the endpoint used for processing the response
                };
            } catch (error) {
                console.error('Error in sendChatMessage:', error);
                return {
                    ok: false,
                    error: error.message,
                    details: error
                };
            }
        }
        
        // Find an alternative model when the selected one fails
        async function findAlternativeModel(failedModel) {
            try {
                // Get current list of models
                let models = [];
                if (fetchedModels.length > 0) {
                    models = fetchedModels;
                } else {
                    const response = await fetch(`${BASE_URL}/v1/models`, {
                        headers: {
                            'Authorization': `Bearer ${currentApiKey}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        models = data.data.map(model => model.id);
                    }
                }
                
                if (models.length > 0) {
                    // Extract the base name of the failed model (without provider prefix)
                    const failedModelBase = failedModel.split('/').pop();
                    
                    // First, try to find models from the same provider
                    const failedProvider = failedModel.split('/')[0];
                    const sameProviderModels = models.filter(model => 
                        model.startsWith(failedProvider) && model !== failedModel
                    );
                    
                    // Sort same provider models by similarity to failed model
                    sameProviderModels.sort((a, b) => {
                        const aBase = a.split('/').pop();
                        const bBase = b.split('/').pop();
                        // Prefer models with similar names
                        const aSimilarity = calculateSimilarity(failedModelBase, aBase);
                        const bSimilarity = calculateSimilarity(failedModelBase, bBase);
                        return bSimilarity - aSimilarity; // Higher similarity first
                    });
                    
                    if (sameProviderModels.length > 0) {
                        return sameProviderModels[0];
                    }
                    
                    // If no same provider models, find models with similar names
                    const similarModels = models.filter(model => model !== failedModel);
                    similarModels.sort((a, b) => {
                        const aBase = a.split('/').pop();
                        const bBase = b.split('/').pop();
                        const aSimilarity = calculateSimilarity(failedModelBase, aBase);
                        const bSimilarity = calculateSimilarity(failedModelBase, bBase);
                        return bSimilarity - aSimilarity; // Higher similarity first
                    });
                    
                    if (similarModels.length > 0) {
                        return similarModels[0];
                    }
                    
                    // Fallback to first available model
                    for (const model of models) {
                        if (model !== failedModel) {
                            return model;
                        }
                    }
                }
            } catch (error) {
                console.error('Error fetching models for fallback:', error);
            }
            
            // If we can't fetch models, try with the hardcoded list
            for (const model of availableModels) {
                if (model !== failedModel) {
                    return model;
                }
            }
            
            return null; // No alternative model found
        }
        
        // Calculate similarity between two strings (simple implementation)
        function calculateSimilarity(str1, str2) {
            // Convert to lowercase for case-insensitive comparison
            str1 = str1.toLowerCase();
            str2 = str2.toLowerCase();
            
            // If one string contains the other, it's a good match
            if (str1.includes(str2) || str2.includes(str1)) {
                return 0.8;
            }
            
            // Check for common prefixes/suffixes
            const commonPrefixLength = Math.min(str1.length, str2.length);
            let matchLength = 0;
            for (let i = 0; i < commonPrefixLength; i++) {
                if (str1[i] === str2[i]) {
                    matchLength++;
                } else {
                    break;
                }
            }
            
            return matchLength / Math.max(str1.length, str2.length);
        }
        
        // Clean model name to remove provider prefix
        function cleanModelName(modelName) {
            if (!modelName) return 'Assistant';
            // Remove provider prefix (e.g., "provider-3/gpt-4o" -> "gpt-4o")
            return modelName.split('/').pop();
        }
        
        // Load chat history from localStorage
        function loadChatHistory() {
            const savedHistory = localStorage.getItem('chatNcpHistory');
            if (savedHistory) {
                chatHistory = JSON.parse(savedHistory);
            }
        }
        
        // Save chat history to localStorage
        function saveChatHistory() {
            localStorage.setItem('chatNcpHistory', JSON.stringify(chatHistory));
        }
        
        // Render chat history in sidebar
        function renderChatHistory() {
            historyList.innerHTML = '';
            chatHistory.slice(0, 20).forEach(chat => {
                const li = document.createElement('li');
                li.className = 'history-item';
                if (chat.id === currentChatId) {
                    li.classList.add('active');
                }
                
                // Create container for chat item content
                const chatContent = document.createElement('div');
                chatContent.className = 'history-item-content';
                chatContent.innerHTML = `
                    <i class="fas fa-message"></i>
                    <span class="history-item-title">${chat.title || 'New Chat'}</span>
                `;
                
                // Create container for chat actions
                const chatActions = document.createElement('div');
                chatActions.className = 'history-item-actions';
                chatActions.innerHTML = `
                    <i class="fas fa-edit edit-chat" title="Edit chat name"></i>
                    <i class="fas fa-trash delete-chat" title="Delete chat"></i>
                `;
                
                // Hide actions by default
                chatActions.style.display = 'none';
                
                li.appendChild(chatContent);
                li.appendChild(chatActions);
                
                // Add event listener to load chat
                chatContent.addEventListener('click', () => loadChat(chat.id));
                
                // Add hover events to show/hide actions
                li.addEventListener('mouseenter', () => {
                    chatActions.style.display = 'flex';
                });
                
                li.addEventListener('mouseleave', () => {
                    chatActions.style.display = 'none';
                });
                
                // Add event listeners for edit and delete actions
                chatActions.querySelector('.edit-chat').addEventListener('click', (e) => {
                    e.stopPropagation();
                    editChatName(chat.id);
                });
                
                chatActions.querySelector('.delete-chat').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteChat(chat.id);
                });
                
                historyList.appendChild(li);
            });
        }
        
        // Edit chat name
        function editChatName(chatId) {
            const chat = chatHistory.find(c => c.id === chatId);
            if (chat) {
                const newTitle = prompt('Enter new chat name:', chat.title || 'New Chat');
                if (newTitle !== null) {
                    chat.title = newTitle;
                    saveChatHistory();
                    renderChatHistory();
                }
            }
        }
        
        // Delete chat
        function deleteChat(chatId) {
            if (chatHistory.length <= 1) {
                alert('Cannot delete the last chat.');
                return;
            }
            
            if (confirm('Are you sure you want to delete this chat?')) {
                chatHistory = chatHistory.filter(c => c.id !== chatId);
                saveChatHistory();
                
                // If we deleted the current chat, load the first one
                if (currentChatId === chatId) {
                    loadChat(chatHistory[0].id);
                } else {
                    renderChatHistory();
                }
            }
        }
        
        // Load a specific chat
        function loadChat(chatId) {
            const chat = chatHistory.find(c => c.id === chatId);
            if (chat) {
                currentChatId = chatId;
                clearChat();
                chat.messages.forEach(msg => {
                    // Pass the model name if it exists in the message
                    addMessageToChat(msg.role, msg.content, msg.images || [], msg.modelName || null);
                });
                renderChatHistory();
            }
        }
        
        // Handle logout
        function handleLogout() {
            console.log('Logging out...');
            // Remove API key from localStorage
            localStorage.removeItem('chatNcpApiKey');
            
            // Reset global variables
            currentApiKey = null;
            chatHistory = [];
            
            // Hide app and show login
            appContainer.classList.add('hidden');
            loginSection.classList.remove('hidden');
            
            // Clear login form
            document.getElementById('clientApiKey').value = '';
        }
        
        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, checking for saved API key...');
            // Check if already logged in
            const savedApiKey = localStorage.getItem('chatNcpApiKey');
            console.log('Saved API key found:', savedApiKey);
            if (savedApiKey) {
                // Validate the saved API key before using it
                validateApiKey(savedApiKey).then(isValid => {
                    console.log('API key validation result:', isValid);
                    if (isValid) {
                        currentApiKey = savedApiKey;
                        loginSection.classList.add('hidden');
                        appContainer.classList.remove('hidden');
                        sidebarApiKey.textContent = savedApiKey;
                        
                        // Initialize the app components without re-adding event listeners
                        loadChatHistory();
                        createNewChat();
                        // Fetch models from upstream API
                        fetchModels();
                        
                        // Set up event listeners only once
                        setupEventListeners();
                    } else {
                        // If the saved key is invalid, remove it and show login
                        console.log('Saved API key is invalid, removing it');
                        localStorage.removeItem('chatNcpApiKey');
                        // Set up event listeners for login
                        setupEventListeners();
                    }
                });
            } else {
                // Set up event listeners for login
                setupEventListeners();
            }
        });
        
        // Function to validate API key
        async function validateApiKey(apiKey) {
            try {
                console.log('Validating API key:', apiKey);
                const response = await fetch(`${BASE_URL}/client/stats`, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                console.log('API key validation response:', response);
                return response.ok;
            } catch (error) {
                console.log('API key validation error:', error);
                return false;
            }
        }
    </script>
</body>
</html>